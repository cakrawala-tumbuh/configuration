name: Cek URL struktur_data (manual)

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install yq v4 (portable, tanpa snap/apt)
      - name: Install yq (v4)
        run: |
          set -euo pipefail
          YQ_VER="v4.44.3"
          curl -sSL -o /usr/local/bin/yq \
            "https://github.com/mikefarah/yq/releases/download/${YQ_VER}/yq_linux_amd64"
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Validasi URL → file (format: key `url`, contoh `./struktur_data/xxx.yml`)
        shell: bash
        run: |
          set -euo pipefail

          FILE_JASA="daftar-jasa.yaml"

          if [[ ! -f "$FILE_JASA" ]]; then
            echo "::error file=$FILE_JASA::File $FILE_JASA tidak ditemukan di repo."
            exit 2
          fi

          # Ambil SEMUA nilai untuk key 'url' (huruf kecil) di mana pun lokasinya.
          # Contoh di file: data: - name: ...  url: ./struktur_data/xxx.yml
          mapfile -t URLS < <(yq -r '.. | .url? // empty' "$FILE_JASA")

          if (( ${#URLS[@]} == 0 )); then
            echo "::warning title=Tidak ada url::Tidak ditemukan key 'url' di $FILE_JASA"
          fi

          echo "## Hasil Validasi" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| url di YAML | STATUS | Path yang dicek |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|---|" >> "$GITHUB_STEP_SUMMARY"

          missing=0
          while IFS= read -r u; do
            # Normalisasi: hapus prefix './' jika ada
            rel="${u#./}"
            # Tidak menambah 'struktur_data/' lagi karena nilai sudah full (mis. struktur_data/xxx.yml)
            if [[ -f "$rel" ]]; then
              echo "| $u | ADA | $rel |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| $u | TIDAK | $rel |" >> "$GITHUB_STEP_SUMMARY"
              echo "::error title=File tidak ditemukan::url '$u' → expected path '$rel' tidak ada"
              missing=$((missing+1))
            fi
          done < <(printf "%s\n" "${URLS[@]}")

          echo "" >> "$GITHUB_STEP_SUMMARY"
          if (( missing > 0 )); then
            echo "**Ada $missing file yang belum tersedia.**" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "✅ Semua \`url\` pada \`$FILE_JASA\` valid (file ada)." >> "$GITHUB_STEP_SUMMARY"
          fi
