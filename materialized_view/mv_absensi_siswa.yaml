name: mv_absensi_siswa
domain: akademik
description: Rekap absensi siswa per periode beserta persentase kehadiran.
purpose:
  - Menyediakan data absensi siswa untuk analisis kedisiplinan
  - Memberikan insight terkait keterkaitan absensi dengan prestasi akademik
sources:
  siswa:
    url: struktur_data/siswa.yaml
  absensi_siswa:
    url: struktur_data/absensi_siswa.yaml
primary_key:
  - siswa_id
  - periode
columns:
  - name: periode
    type: date
    nullable: false
    description: Periode absensi (bulanan).
    source:
      ref: absensi_siswa
      column: tanggal
    transform: "date_trunc('month', absensi_siswa.tanggal)::date"
    example: 2025-07-01

  - name: siswa_id
    type: uuid
    nullable: false
    description: Identitas unik siswa.
    source:
      ref: siswa
      column: id
    example: "c223e456-78d9-42b3-a456-426614174111"

  - name: nama_siswa
    type: text
    nullable: false
    description: Nama lengkap siswa.
    source:
      ref: siswa
      column: nama
    example: "Budi Santoso"

  - name: tingkat_kehadiran
    type: numeric(5,2)
    nullable: true
    description: Persentase kehadiran siswa dalam periode (%).
    source:
      ref: absensi_siswa
      column: status
    transform: "round((count(*) filter (where absensi_siswa.status='hadir')::numeric / nullif(count(*),0)) * 100, 2)"
    example: 92.30

  - name: jumlah_izin
    type: integer
    nullable: true
    description: Jumlah izin resmi yang diajukan siswa dalam periode.
    source:
      ref: absensi_siswa
      column: status
    transform: "count(*) filter (where absensi_siswa.status='izin')"
    example: 2

  - name: jumlah_sakit
    type: integer
    nullable: true
    description: Jumlah ketidakhadiran karena sakit.
    source:
      ref: absensi_siswa
      column: status
    transform: "count(*) filter (where absensi_siswa.status='sakit')"
    example: 1

  - name: jumlah_alpa
    type: integer
    nullable: true
    description: Jumlah ketidakhadiran tanpa keterangan (alpa).
    source:
      ref: absensi_siswa
      column: status
    transform: "count(*) filter (where absensi_siswa.status='alpa')"
    example: 0

dependencies:
  base_entities:
    - siswa
    - absensi_siswa
  views: []
  materialized_views: []

refresh_policy:
  strategy: scheduled
  schedule_cron: "0 2 * * *"
  with_data_on_create: true
  concurrently_on_refresh: true
  invalidate:
    - Absensi siswa baru masuk

indexes:
  - name: mv_absensi_siswa_pk
    type: unique
    columns:
      - periode
      - siswa_id

retention:
  keep_history_months: 24
  prune_policy: hapus data > keep_history_months

security:
  grant_read_to_roles:
    - bi_analyst
    - wali_kelas
  pii:
    contains_pii: true
    columns:
      - nama_siswa

notes:
  - Data absensi siswa bisa dihubungkan dengan nilai akademik untuk analisis prestasi.
  - Perlu validasi agar entri ganda tidak menyebabkan bias perhitungan.
